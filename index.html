async function transcribe(audio) {
    document.getElementById('loader').classList.add('active');
    document.getElementById('loaderText').textContent = 'Transcription en cours...';
    document.getElementById('resultCard').classList.remove('active');

    try {
        const b64 = await new Promise((res, rej) => {
            const reader = new FileReader();
            reader.onloadend = () => res(reader.result.split(',')[1]);
            reader.onerror = rej;
            reader.readAsDataURL(audio);
        });

        const resp = await fetch(WORKER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            },
            body: JSON.stringify({
                type: 'audio',
                audio: b64,
                mimeType: audio.type || 'audio/webm'
            })
        });

        // Correction majeure : Utiliser .json() et vérifier la clé .text
        const data = await resp.json();
        
        if (!resp.ok || data.error) {
            throw new Error(data.error || 'Erreur lors de la transcription');
        }

        const text = data.text;
        if (!text) throw new Error('Le texte transcrit est vide.');

        currentText = text;
        document.getElementById('resultText').textContent = text;
        document.getElementById('wordCount').textContent = text.trim().split(/\s+/).length + ' mots';

        const addMin = Math.ceil(secs / 60) || 1;
        await updateQuotaDB(addMin);
        totalCount++;
        document.getElementById('statCount').textContent = totalCount;

        document.getElementById('loader').classList.remove('active');
        document.getElementById('resultCard').classList.add('active');
        document.getElementById('micStatus').textContent = 'Appuyez pour enregistrer';
        document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });

        await saveTranscription(text);
        loadHistory();

    } catch (err) {
        document.getElementById('loader').classList.remove('active');
        document.getElementById('micStatus').textContent = 'Appuyez pour enregistrer';
        alert('❌ ' + err.message);
    }
}
