<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceScribe - Transcription IA</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">ğŸ™ï¸ VoiceScribe</div>
            <div class="tagline">Transcription audio instantanÃ©e par IA</div>
        </header>

        <div class="recorder-section">
            <button class="mic-button" id="micButton" onclick="toggleRecording()">
                <span class="mic-icon" id="micIcon">ğŸ¤</span>
            </button>
            <div class="status-text" id="statusText">PrÃªt Ã  enregistrer</div>
            <div class="timer" id="timer">00:00</div>
            <div class="hint-text">Appuyez sur le micro pour commencer</div>
        </div>

        <div class="upload-section">
            <div class="upload-icon">ğŸ“</div>
            <h3 style="margin-bottom: 12px; font-size: 1.3rem; font-weight: 700;">Ou importez un fichier audio</h3>
            <p style="color: var(--text-light); margin-bottom: 20px; font-size: 0.9rem;">MP3, WAV, M4A, OGG (max 100 MB)</p>
            <input type="file" id="audioFile" accept="audio/*" style="display:none">
            <button class="upload-btn" onclick="document.getElementById('audioFile').click()">
                ğŸ“¤ Importer un fichier
            </button>
        </div>

        <div class="loader" id="loader">
            <div class="spinner"></div>
            <div class="loader-text">ğŸ¤– Transcription en cours...</div>
        </div>

        <div class="transcription-section" id="transcriptionSection">
            <div class="transcription-header">
                <div class="transcription-title">ğŸ“ Transcription</div>
                <div class="word-count" id="wordCount">0 mots</div>
            </div>
            <div class="transcription-text" id="transcriptionText">
                Votre transcription apparaÃ®tra ici...
            </div>
            <div class="usage-badge">
                â±ï¸ Minutes gratuites utilisÃ©es: <span id="minutesLeft">0/10</span>
            </div>
            <div class="action-buttons">
                <button class="action-btn" onclick="copyTranscription()">ğŸ“‹ Copier</button>
                <button class="action-btn" onclick="downloadTranscription()">ğŸ’¾ TÃ©lÃ©charger</button>
                <button class="action-btn" onclick="newTranscription()">ğŸ”„ Nouveau</button>
                <button class="action-btn primary" onclick="translateText()">ğŸŒ Traduire</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value">2M+</div>
                <div class="stat-label">Heures transcrites</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">98%</div>
                <div class="stat-label">PrÃ©cision</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">150K+</div>
                <div class="stat-label">Utilisateurs</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration Worker Cloudflare
        const WORKER_URL = 'https://voice.assolemetchaba67.workers.dev';

        let isRecording = false;
        let recordingInterval;
        let seconds = 0;
        let minutesUsed = 0;
        const maxFreeMinutes = 10;
        let mediaRecorder;
        let audioChunks = [];

        // Gestion fichier importÃ©
        document.getElementById('audioFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) transcribeAudio(file);
        });

        function toggleRecording() {
            const button = document.getElementById('micButton');
            const icon = document.getElementById('micIcon');
            const status = document.getElementById('statusText');

            if (!isRecording) {
                if (minutesUsed >= maxFreeMinutes) {
                    alert('ğŸš« Limite gratuite atteinte!');
                    return;
                }
                startRecording();
                isRecording = true;
                button.classList.add('recording');
                icon.textContent = 'â¹ï¸';
                status.textContent = 'Enregistrement en cours...';
                document.getElementById('timer').classList.add('recording');
                seconds = 0;
                recordingInterval = setInterval(() => { seconds++; updateTimer(); }, 1000);
            } else {
                stopRecording();
                isRecording = false;
                button.classList.remove('recording');
                icon.textContent = 'ğŸ¤';
                status.textContent = 'Traitement...';
                document.getElementById('timer').classList.remove('recording');
                clearInterval(recordingInterval);
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    transcribeAudio(audioBlob);
                };
                mediaRecorder.start();
            } catch (error) {
                alert('âŒ Impossible d\'accÃ©der au microphone. VÃ©rifiez les permissions.');
                document.getElementById('statusText').textContent = 'PrÃªt Ã  enregistrer';
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(t => t.stop());
            }
        }

        function updateTimer() {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timer').textContent =
                `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
        }

        async function transcribeAudio(audioData) {
            document.getElementById('loader').classList.add('active');
            document.getElementById('transcriptionSection').classList.remove('active');
            document.getElementById('statusText').textContent = 'Transcription en cours...';

            try {
                // Convertir audio en base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(audioData);
                });

                const mimeType = audioData.type || 'audio/webm';

                // Appeler le Worker Cloudflare
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: mimeType, data: base64 } },
                                { text: "Transcris exactement ce qui est dit dans cet audio. Retourne uniquement la transcription, sans commentaires." }
                            ]
                        }]
                    })
                });

                if (!response.ok) throw new Error('Erreur serveur: ' + response.status);

                const data = await response.json();

                if (data.error) throw new Error(data.error.message || 'Erreur Gemini');

                const transcription = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!transcription) throw new Error('Aucune transcription reÃ§ue');

                const wordCount = transcription.trim().split(/\s+/).length;
                document.getElementById('transcriptionText').textContent = transcription;
                document.getElementById('wordCount').textContent = `${wordCount} mots`;
                minutesUsed += Math.ceil(seconds / 60) || 1;
                document.getElementById('minutesLeft').textContent = `${minutesUsed}/${maxFreeMinutes}`;
                document.getElementById('loader').classList.remove('active');
                document.getElementById('transcriptionSection').classList.add('active');
                document.getElementById('statusText').textContent = 'PrÃªt Ã  enregistrer';
                document.getElementById('transcriptionSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                document.getElementById('loader').classList.remove('active');
                document.getElementById('statusText').textContent = 'PrÃªt Ã  enregistrer';
                alert('âŒ Erreur: ' + error.message);
            }
        }

        function copyTranscription() {
            const text = document.getElementById('transcriptionText').textContent;
            navigator.clipboard.writeText(text).then(() => alert('âœ… Transcription copiÃ©e!'));
        }

        function downloadTranscription() {
            const text = document.getElementById('transcriptionText').textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transcription.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function newTranscription() {
            document.getElementById('transcriptionSection').classList.remove('active');
            seconds = 0;
            updateTimer();
        }

        function translateText() {
            alert('ğŸŒ Traduction disponible en Premium!');
        }
    </script>
</body>
</html>
