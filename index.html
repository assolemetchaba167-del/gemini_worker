<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>VoiceScribe</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --g1: #667eea;
            --g2: #764ba2;
            --g3: #f093fb;
            --g4: #f5576c;
            --g5: #4facfe;
            --g6: #00f2fe;
            --accent: #ffd93d;
            --bg: #f0f2ff;
            --white: #ffffff;
            --text: #1a1a2e;
            --muted: #6b7280;
            --border: #e5e7eb;
            --card: #ffffff;
            --success: #10b981;
            --error: #ef4444;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            max-width: 430px;
            margin: 0 auto;
            overflow-x: hidden;
        }

        /* ===== AUTH ===== */
        #authScreen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .auth-hero {
            background: linear-gradient(135deg, var(--g1), var(--g2), var(--g3));
            padding: 60px 32px 48px;
            text-align: center;
            border-radius: 0 0 40px 40px;
            position: relative;
            overflow: hidden;
        }

        .auth-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .auth-hero::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -20%;
            width: 250px;
            height: 250px;
            background: rgba(255,255,255,0.07);
            border-radius: 50%;
        }

        .hero-icon {
            font-size: 56px;
            display: block;
            margin-bottom: 16px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .hero-title {
            font-size: 32px;
            font-weight: 800;
            color: white;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }

        .hero-sub {
            color: rgba(255,255,255,0.85);
            font-size: 14px;
            font-weight: 500;
        }

        .auth-body {
            padding: 28px 24px;
            flex: 1;
        }

        .auth-tabs {
            display: flex;
            background: var(--border);
            border-radius: 14px;
            padding: 4px;
            margin-bottom: 24px;
        }

        .auth-tab {
            flex: 1;
            padding: 11px;
            border-radius: 11px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--muted);
            cursor: pointer;
            transition: all 0.25s;
            border: none;
            background: none;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .auth-tab.active {
            background: white;
            color: var(--g1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-group { margin-bottom: 14px; }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 7px;
            display: block;
        }

        .form-input {
            width: 100%;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 14px;
            padding: 14px 16px;
            font-size: 15px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text);
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus { border-color: var(--g1); background: white; }

        .btn-grad {
            width: 100%;
            background: linear-gradient(135deg, var(--g1), var(--g2));
            color: white;
            border: none;
            border-radius: 14px;
            padding: 16px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Plus Jakarta Sans', sans-serif;
            box-shadow: 0 4px 20px rgba(102,126,234,0.4);
            transition: all 0.25s;
            margin-top: 6px;
        }

        .btn-grad:active { transform: scale(0.98); }
        .btn-grad:disabled { opacity: 0.6; }

        .auth-msg {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 14px;
            display: none;
        }

        .auth-msg.error { background: #fef2f2; color: var(--error); border: 1px solid #fecaca; display: block; }
        .auth-msg.success { background: #f0fdf4; color: var(--success); border: 1px solid #bbf7d0; display: block; }

        /* ===== APP ===== */
        #appScreen { display: none; }

        .app-header {
            background: linear-gradient(135deg, var(--g1), var(--g2));
            padding: 48px 20px 24px;
            border-radius: 0 0 32px 32px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .app-logo {
            font-size: 20px;
            font-weight: 800;
            color: white;
            letter-spacing: -0.5px;
        }

        .app-logo span { opacity: 0.7; }

        .user-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 6px 12px;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .user-name {
            font-size: 12px;
            color: white;
            font-weight: 600;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-logout-small {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .header-stats {
            display: flex;
            gap: 12px;
        }

        .stat-pill {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 8px 14px;
            flex: 1;
            text-align: center;
        }

        .stat-num {
            font-size: 18px;
            font-weight: 800;
            color: white;
        }

        .stat-label {
            font-size: 10px;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }

        .app-body { padding: 20px 16px; }

        /* ===== MIC CARD ===== */
        .mic-card {
            background: white;
            border-radius: 28px;
            padding: 32px 20px;
            text-align: center;
            box-shadow: 0 4px 24px rgba(102,126,234,0.12);
            margin-bottom: 16px;
        }

        .mic-outer {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .mic-ring {
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: 2px solid rgba(102,126,234,0.2);
            animation: none;
        }

        .mic-ring.active {
            animation: ringPulse 1.2s ease-out infinite;
        }

        @keyframes ringPulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        .mic-btn {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--g1), var(--g2));
            border: none;
            cursor: pointer;
            font-size: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(102,126,234,0.4);
            transition: all 0.3s;
            position: relative;
            z-index: 1;
        }

        .mic-btn:active { transform: scale(0.95); }

        .mic-btn.recording {
            background: linear-gradient(135deg, var(--g4), #c0392b);
            box-shadow: 0 8px 32px rgba(245,87,108,0.5);
        }

        .mic-status {
            font-size: 14px;
            color: var(--muted);
            font-weight: 500;
            margin-bottom: 6px;
        }

        .mic-timer {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--g1), var(--g2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }

        .mic-timer.rec {
            background: linear-gradient(135deg, var(--g4), #c0392b);
            -webkit-background-clip: text;
            background-clip: text;
        }

        .mic-hint { font-size: 12px; color: var(--muted); margin-top: 8px; }

        /* ===== UPLOAD ===== */
        .upload-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            margin-bottom: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .upload-card:active { transform: scale(0.98); }

        .upload-icon-wrap {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--g5), var(--g6));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .upload-info h3 { font-size: 15px; font-weight: 700; margin-bottom: 3px; }
        .upload-info p { font-size: 12px; color: var(--muted); }

        .upload-arrow {
            margin-left: auto;
            font-size: 20px;
            color: var(--muted);
        }

        /* ===== LOADER ===== */
        .loader {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }

        .loader.active { display: block; animation: fadeUp 0.3s ease; }

        .loader-spinner {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--g1), var(--g3));
            margin: 0 auto 16px;
            animation: spin 0.8s linear infinite;
            position: relative;
        }

        .loader-spinner::after {
            content: '';
            position: absolute;
            inset: 4px;
            background: white;
            border-radius: 50%;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-text { font-size: 14px; font-weight: 600; color: var(--g1); }
        .loader-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

        /* ===== RESULT ===== */
        .result-card {
            display: none;
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            margin-bottom: 16px;
        }

        .result-card.active { display: block; animation: fadeUp 0.4s ease; }

        .result-top {
            background: linear-gradient(135deg, var(--g1), var(--g2));
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .result-title { font-size: 15px; font-weight: 700; color: white; }
        .result-badge {
            background: rgba(255,255,255,0.25);
            color: white;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .result-body { padding: 20px; }

        .result-text {
            font-size: 15px;
            line-height: 1.75;
            color: var(--text);
            background: var(--bg);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px;
            min-height: 80px;
        }

        .quota-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .quota-track {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .quota-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--g1), var(--g3));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .quota-text { font-size: 12px; color: var(--muted); font-weight: 600; white-space: nowrap; }

        .actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn-act {
            padding: 13px 10px;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            font-family: 'Plus Jakarta Sans', sans-serif;
            border: none;
        }

        .btn-act:active { transform: scale(0.96); }

        .btn-act.outline {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-act.outline:hover { border-color: var(--g1); color: var(--g1); }

        .btn-act.grad {
            background: linear-gradient(135deg, var(--g1), var(--g2));
            color: white;
            box-shadow: 0 3px 12px rgba(102,126,234,0.35);
        }

        .btn-act.grad2 {
            background: linear-gradient(135deg, var(--g5), var(--g6));
            color: white;
            box-shadow: 0 3px 12px rgba(79,172,254,0.35);
        }

        /* ===== HISTORY ===== */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            margin-top: 8px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text);
        }

        .history-item {
            background: white;
            border-radius: 16px;
            padding: 14px 16px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .history-item:active { transform: scale(0.98); }

        .history-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--g1), var(--g3));
            margin-top: 6px;
            flex-shrink: 0;
        }

        .history-content { flex: 1; min-width: 0; }
        .history-date { font-size: 11px; color: var(--muted); font-weight: 500; margin-bottom: 4px; }
        .history-preview { font-size: 13px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }

        /* ===== UTILS ===== */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- ======= AUTH ======= -->
<div id="authScreen">
    <div class="auth-hero">
        <span class="hero-icon">üéôÔ∏è</span>
        <div class="hero-title">VoiceScribe</div>
        <div class="hero-sub">Transcription audio instantan√©e par IA</div>
    </div>

    <div class="auth-body">
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchTab('login')">Connexion</button>
            <button class="auth-tab" onclick="switchTab('signup')">Inscription</button>
        </div>

        <div id="loginForm">
            <div class="form-group">
                <label class="form-label">Adresse email</label>
                <input class="form-input" type="email" id="loginEmail" placeholder="vous@exemple.com">
            </div>
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input class="form-input" type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn-grad" onclick="login()" id="loginBtn">Se connecter ‚Üí</button>
        </div>

        <div id="signupForm" class="hidden">
            <div class="form-group">
                <label class="form-label">Adresse email</label>
                <input class="form-input" type="email" id="signupEmail" placeholder="vous@exemple.com">
            </div>
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input class="form-input" type="password" id="signupPassword" placeholder="Minimum 6 caract√®res">
            </div>
            <button class="btn-grad" onclick="signup()" id="signupBtn">Cr√©er mon compte ‚Üí</button>
        </div>

        <div class="auth-msg" id="authMsg"></div>
    </div>
</div>

<!-- ======= APP ======= -->
<div id="appScreen">
    <div class="app-header">
        <div class="header-top">
            <div class="app-logo">Voice<span>Scribe</span></div>
            <div style="display:flex;gap:8px;align-items:center;">
                <div class="user-pill">
                    <div class="user-avatar">üë§</div>
                    <span class="user-name" id="userEmail"></span>
                </div>
                <button class="btn-logout-small" onclick="logout()">‚èè</button>
            </div>
        </div>
        <div class="header-stats">
            <div class="stat-pill">
                <div class="stat-num" id="statTranscriptions">0</div>
                <div class="stat-label">Transcriptions</div>
            </div>
            <div class="stat-pill">
                <div class="stat-num" id="statMinutes">0/10</div>
                <div class="stat-label">Min utilis√©es</div>
            </div>
            <div class="stat-pill">
                <div class="stat-num">IA</div>
                <div class="stat-label">Gemini Pro</div>
            </div>
        </div>
    </div>

    <div class="app-body">
        <!-- MIC -->
        <div class="mic-card">
            <div class="mic-outer">
                <div class="mic-ring" id="micRing"></div>
                <button class="mic-btn" id="micBtn" onclick="toggleRecording()">
                    <span id="micIcon">üé§</span>
                </button>
            </div>
            <div class="mic-status" id="micStatus">Appuyez pour enregistrer</div>
            <div class="mic-timer" id="timer">00:00</div>
            <div class="mic-hint">Parlez clairement dans le microphone</div>
        </div>

        <!-- UPLOAD -->
        <div class="upload-card" onclick="document.getElementById('audioFile').click()">
            <div class="upload-icon-wrap">üìÅ</div>
            <div class="upload-info">
                <h3>Importer un fichier</h3>
                <p>MP3, WAV, M4A ‚Äî max 700 KB</p>
            </div>
            <div class="upload-arrow">‚Ä∫</div>
            <input type="file" id="audioFile" accept="audio/*" class="hidden">
        </div>

        <!-- LOADER -->
        <div class="loader" id="loader">
            <div class="loader-spinner"></div>
            <div class="loader-text">Transcription en cours...</div>
            <div class="loader-sub">Gemini analyse votre audio</div>
        </div>

        <!-- RESULT -->
        <div class="result-card" id="resultCard">
            <div class="result-top">
                <div class="result-title">üìù Transcription</div>
                <div class="result-badge" id="wordCount">0 mots</div>
            </div>
            <div class="result-body">
                <div class="result-text" id="resultText"></div>
                <div class="quota-row">
                    <div class="quota-track">
                        <div class="quota-fill" id="quotaFill" style="width:0%"></div>
                    </div>
                    <div class="quota-text" id="quotaText">0/10 min</div>
                </div>
                <div class="actions-grid">
                    <button class="btn-act outline" onclick="copyText()">üìã Copier</button>
                    <button class="btn-act grad2" onclick="downloadDoc()">üíæ T√©l√©charger</button>
                    <button class="btn-act outline" onclick="newTranscription()">üîÑ Nouveau</button>
                    <button class="btn-act grad" onclick="translateAlert()">üåê Traduire</button>
                </div>
            </div>
        </div>

        <!-- HISTORY -->
        <div id="historySection" class="hidden">
            <div class="section-header">
                <div class="section-title">Historique</div>
            </div>
            <div id="historyList"></div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://nyyjxlinxgbdjtavnmpz.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_jG7gszCRGQ1EamS95F0xcg_mVtlwW8H';
    const WORKER_URL = 'https://voice.assolemetchaba67.workers.dev';

    const getToken = () => localStorage.getItem('vs_token');
    const setToken = t => localStorage.setItem('vs_token', t);
    const getUser = () => { try { return JSON.parse(localStorage.getItem('vs_user')); } catch { return null; } };
    const setUser = u => localStorage.setItem('vs_user', JSON.stringify(u));
    const clearSession = () => { localStorage.removeItem('vs_token'); localStorage.removeItem('vs_user'); };

    const authHeaders = () => ({
        'Content-Type': 'application/json',
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${getToken() || SUPABASE_KEY}`
    });

    // AUTH
    let currentTab = 'login';

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
        document.getElementById('signupForm').classList.toggle('hidden', tab !== 'signup');
        document.querySelectorAll('.auth-tab').forEach((t, i) => {
            t.classList.toggle('active', (i === 0) === (tab === 'login'));
        });
        document.getElementById('authMsg').className = 'auth-msg';
    }

    function showMsg(msg, type) {
        const el = document.getElementById('authMsg');
        el.textContent = msg;
        el.className = `auth-msg ${type}`;
    }

    async function login() {
        const email = document.getElementById('loginEmail').value.trim();
        const pass = document.getElementById('loginPassword').value;
        if (!email || !pass) return showMsg('Veuillez remplir tous les champs', 'error');
        const btn = document.getElementById('loginBtn');
        btn.disabled = true; btn.textContent = 'Connexion...';
        const r = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
            body: JSON.stringify({ email, password: pass })
        });
        const d = await r.json();
        btn.disabled = false; btn.textContent = 'Se connecter ‚Üí';
        if (d.access_token) { setToken(d.access_token); setUser(d.user); showApp(); }
        else showMsg(d.error_description || 'Email ou mot de passe incorrect', 'error');
    }

    async function signup() {
        const email = document.getElementById('signupEmail').value.trim();
        const pass = document.getElementById('signupPassword').value;
        if (!email || !pass) return showMsg('Veuillez remplir tous les champs', 'error');
        if (pass.length < 6) return showMsg('Mot de passe trop court (min 6 caract√®res)', 'error');
        const btn = document.getElementById('signupBtn');
        btn.disabled = true; btn.textContent = 'Cr√©ation...';
        const r = await fetch(`${SUPABASE_URL}/auth/v1/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
            body: JSON.stringify({ email, password: pass })
        });
        const d = await r.json();
        btn.disabled = false; btn.textContent = 'Cr√©er mon compte ‚Üí';
        if (d.id || d.user) showMsg('‚úÖ Compte cr√©√© ! V√©rifiez votre email.', 'success');
        else showMsg(d.error_description || d.msg || 'Erreur inscription', 'error');
    }

    async function logout() {
        await fetch(`${SUPABASE_URL}/auth/v1/logout`, { method: 'POST', headers: authHeaders() });
        clearSession();
        document.getElementById('appScreen').style.display = 'none';
        document.getElementById('authScreen').style.display = 'flex';
    }

    function showApp() {
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('appScreen').style.display = 'block';
        const u = getUser();
        if (u) document.getElementById('userEmail').textContent = u.email.split('@')[0];
        loadHistory();
    }

    window.addEventListener('load', () => { if (getToken() && getUser()) showApp(); });

    // RECORDER
    let isRec = false, recorder, chunks = [], secs = 0, mins = 0, tInterval;

    function toggleRecording() {
        isRec ? stopRec() : startRec();
    }

    async function startRec() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);
            chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => transcribe(new Blob(chunks, { type: 'audio/webm' }));
            recorder.start();
            isRec = true;
            document.getElementById('micBtn').classList.add('recording');
            document.getElementById('micRing').classList.add('active');
            document.getElementById('micIcon').textContent = '‚èπÔ∏è';
            document.getElementById('micStatus').textContent = 'Enregistrement...';
            document.getElementById('timer').classList.add('rec');
            secs = 0;
            tInterval = setInterval(() => { secs++; updateTimer(); }, 1000);
        } catch { alert('‚ùå Acc√®s au microphone refus√©'); }
    }

    function stopRec() {
        if (recorder && recorder.state !== 'inactive') {
            recorder.stop();
            recorder.stream.getTracks().forEach(t => t.stop());
        }
        isRec = false;
        clearInterval(tInterval);
        document.getElementById('micBtn').classList.remove('recording');
        document.getElementById('micRing').classList.remove('active');
        document.getElementById('micIcon').textContent = 'üé§';
        document.getElementById('micStatus').textContent = 'Traitement...';
        document.getElementById('timer').classList.remove('rec');
    }

    function updateTimer() {
        const m = String(Math.floor(secs/60)).padStart(2,'0');
        const s = String(secs%60).padStart(2,'0');
        document.getElementById('timer').textContent = `${m}:${s}`;
    }

    document.getElementById('audioFile').addEventListener('change', e => {
        if (e.target.files[0]) transcribe(e.target.files[0]);
    });

    // TRANSCRIPTION
    let totalMins = 0, totalCount = 0;

    async function transcribe(audio) {
        document.getElementById('loader').classList.add('active');
        document.getElementById('resultCard').classList.remove('active');

        try {
            const b64 = await new Promise((res, rej) => {
                const r = new FileReader();
                r.onloadend = () => res(r.result.split(',')[1]);
                r.onerror = rej;
                r.readAsDataURL(audio);
            });

            const resp = await fetch(WORKER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [
                        { inline_data: { mime_type: audio.type || 'audio/webm', data: b64 } },
                        { text: "Transcris exactement ce qui est dit dans cet audio. Retourne uniquement la transcription, sans commentaires." }
                    ]}]
                })
            });

            if (!resp.ok) throw new Error('Erreur serveur ' + resp.status);
            const data = await resp.json();
            if (data.error) throw new Error(data.error.message);
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error('Aucune transcription re√ßue');

            document.getElementById('resultText').textContent = text;
            const wc = text.trim().split(/\s+/).length;
            document.getElementById('wordCount').textContent = wc + ' mots';

            const addMin = Math.ceil(secs / 60) || 1;
            totalMins += addMin;
            totalCount++;
            document.getElementById('quotaText').textContent = `${totalMins}/10 min`;
            document.getElementById('quotaFill').style.width = Math.min(totalMins * 10, 100) + '%';
            document.getElementById('statMinutes').textContent = `${totalMins}/10`;
            document.getElementById('statTranscriptions').textContent = totalCount;

            document.getElementById('loader').classList.remove('active');
            document.getElementById('resultCard').classList.add('active');
            document.getElementById('micStatus').textContent = 'Appuyez pour enregistrer';
            document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });

            await saveTranscription(text);
            loadHistory();

        } catch (err) {
            document.getElementById('loader').classList.remove('active');
            document.getElementById('micStatus').textContent = 'Appuyez pour enregistrer';
            alert('‚ùå ' + err.message);
        }
    }

    // ACTIONS
    function copyText() {
        navigator.clipboard.writeText(document.getElementById('resultText').textContent)
            .then(() => alert('‚úÖ Copi√© !'));
    }

    function downloadDoc() {
        const text = document.getElementById('resultText').textContent;
        const date = new Date().toLocaleDateString('fr-FR');
        const html = `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><style>
body{font-family:Georgia,serif;max-width:680px;margin:48px auto;padding:40px;color:#1a1a2e}
.header{background:linear-gradient(135deg,#667eea,#764ba2);padding:32px;border-radius:16px;margin-bottom:32px;color:white}
h1{font-size:22px;margin-bottom:6px}
.date{opacity:0.8;font-size:13px}
.content{font-size:16px;line-height:1.85;text-align:justify;padding:24px;background:#f8f9ff;border-radius:12px;border-left:4px solid #667eea}
.footer{margin-top:32px;text-align:center;color:#aaa;font-size:12px}
</style></head><body>
<div class="header"><h1>üéôÔ∏è VoiceScribe ‚Äî Transcription</h1><div class="date">Date : ${date}</div></div>
<div class="content">${text}</div>
<div class="footer">Propuls√© par Gemini AI ‚Ä¢ VoiceScribe</div>
</body></html>`;
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `transcription_${date.replace(/\//g,'-')}.html`;
        a.click(); URL.revokeObjectURL(url);
    }

    function newTranscription() {
        document.getElementById('resultCard').classList.remove('active');
        secs = 0; updateTimer();
    }

    function translateAlert() {
        alert('üåê Traduction disponible en Premium !');
    }

    // SUPABASE
    async function saveTranscription(text) {
        const u = getUser();
        if (!u) return;
        await fetch(`${SUPABASE_URL}/rest/v1/transcriptions`, {
            method: 'POST',
            headers: { ...authHeaders(), 'Prefer': 'return=minimal' },
            body: JSON.stringify({ user_id: u.id, text })
        });
    }

    async function loadHistory() {
        const u = getUser();
        if (!u) return;
        try {
            const r = await fetch(`${SUPABASE_URL}/rest/v1/transcriptions?user_id=eq.${u.id}&order=created_at.desc&limit=8`, {
                headers: authHeaders()
            });
            if (!r.ok) return;
            const items = await r.json();
            const section = document.getElementById('historySection');
            const list = document.getElementById('historyList');
            if (!items || items.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            document.getElementById('statTranscriptions').textContent = items.length;
            list.innerHTML = items.map(item => `
                <div class="history-item" onclick="restoreItem(this)" data-text="${encodeURIComponent(item.text)}">
                    <div class="history-dot"></div>
                    <div class="history-content">
                        <div class="history-date">${new Date(item.created_at).toLocaleString('fr-FR')}</div>
                        <div class="history-preview">${item.text}</div>
                    </div>
                </div>
            `).join('');
        } catch {}
    }

    function restoreItem(el) {
        const text = decodeURIComponent(el.dataset.text);
        document.getElementById('resultText').textContent = text;
        document.getElementById('wordCount').textContent = text.trim().split(/\s+/).length + ' mots';
        document.getElementById('resultCard').classList.add('active');
        document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
    }
</script>
</body>
</html>
